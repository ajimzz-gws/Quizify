<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Font: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Apply Inter font family */
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
    <div class="profile-container w-full max-w-2xl bg-white shadow-lg rounded-xl overflow-hidden p-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">User Profile</h1>

        <div class="flex flex-col items-center mb-8">
            <div class="relative w-32 h-32 rounded-full overflow-hidden bg-gray-200 flex items-center justify-center mb-4">
                <!-- Profile picture -->
                <img id="profile-picture" src="https://placehold.co/128x128/cccccc/333333?text=Profile" alt="Profile Picture" class="w-full h-full object-cover">
                <!-- Edit icon overlay -->
                <label for="image-upload" class="absolute bottom-0 right-0 bg-blue-600 p-2 rounded-full cursor-pointer hover:bg-blue-700 transition duration-300">
                    <i class="fas fa-camera text-white text-lg"></i>
                    <input type="file" id="image-upload" accept="image/*" class="hidden" onchange="previewImage(event)">
                </label>
            </div>
            <h2 id="display-name" class="text-2xl font-semibold text-gray-800">John Doe</h2>
            <p id="display-role" class="text-gray-600">Teacher</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="bg-gray-50 p-4 rounded-lg shadow-sm">
                <h3 class="text-lg font-medium text-gray-700 mb-4">Personal Information</h3>
                <div class="mb-4">
                    <label for="name" class="block text-sm font-medium text-gray-700">Name</label>
                    <input type="text" id="name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" value="John Doe">
                </div>
                <div class="mb-4">
                    <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="email" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" value="john.doe@example.com">
                </div>
                <div class="mb-4">
                    <label for="phone" class="block text-sm font-medium text-gray-700">Phone</label>
                    <input type="tel" id="phone" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" value="+123 456 7890">
                </div>
                <div>
                    <label for="dob" class="block text-sm font-medium text-gray-700">Date of Birth</label>
                    <input type="date" id="dob" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" value="1980-01-01">
                </div>
            </div>

            <div class="bg-gray-50 p-4 rounded-lg shadow-sm">
                <h3 class="text-lg font-medium text-gray-700 mb-4">Academic Information</h3>
                <div class="mb-4">
                    <label for="id_number" class="block text-sm font-medium text-gray-700">ID</label>
                    <input type="text" id="id_number" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" value="TCH001" readonly>
                </div>
                <div class="mb-4">
                    <label for="department" class="block text-sm font-medium text-gray-700">Department</label>
                    <input type="text" id="department" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" value="Science">
                </div>
                <div>
                    <label for="classes_taught" class="block text-sm font-medium text-gray-700">Classes Taught</label>
                    <input type="text" id="classes_taught" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2" value="5A, 5B, 6C">
                </div>
            </div>
        </div>

        <div class="flex justify-center space-x-4">
            <button onclick="saveProfileChanges()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-md shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                <i class="fas fa-save mr-2"></i> Save Changes
            </button>
            <button onclick="goBackToDashboard()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-md shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                <i class="fas fa-arrow-left mr-2"></i> Back to Dashboard
            </button>
        </div>
    </div>

    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase variables (will be initialized on window.onload)
        let app;
        let db;
        let auth;
        let userId;
        let appId;

        // Default profile data (for demonstration purposes)
        let userProfile = {
            name: "John Doe",
            email: "john.doe@example.com",
            phone: "+123 456 7890",
            dob: "1980-01-01",
            id: "TCH001",
            department: "Science",
            classesTaught: "5A, 5B, 6C",
            profileImage: "https://placehold.co/128x128/cccccc/333333?text=Profile"
        };

        /**
         * Initializes the form fields and profile picture with current data.
         */
        function loadProfileData() {
            document.getElementById('name').value = userProfile.name;
            document.getElementById('email').value = userProfile.email;
            document.getElementById('phone').value = userProfile.phone;
            document.getElementById('dob').value = userProfile.dob;
            document.getElementById('id_number').value = userProfile.id;
            document.getElementById('department').value = userProfile.department;
            document.getElementById('classes_taught').value = userProfile.classesTaught;
            document.getElementById('profile-picture').src = userProfile.profileImage;
            document.getElementById('display-name').textContent = userProfile.name;
            console.log("Profile Page: Data loaded into form:", userProfile);
        }

        /**
         * Saves the changes made in the profile form fields to Firestore.
         */
        async function saveProfileChanges() {
            userProfile.name = document.getElementById('name').value;
            userProfile.email = document.getElementById('email').value;
            userProfile.phone = document.getElementById('phone').value;
            userProfile.dob = document.getElementById('dob').value;
            userProfile.department = document.getElementById('department').value;
            userProfile.classesTaught = document.getElementById('classes_taught').value;
            userProfile.profileImage = document.getElementById('profile-picture').src;

            // Update displayed name immediately
            document.getElementById('display-name').textContent = userProfile.name;

            console.log("Profile Page: Attempting to save profile changes to Firestore:", userProfile);

            try {
                if (!db || !userId || !appId) {
                    console.error("Firestore not initialized or userId/appId missing.");
                    return;
                }
                const profileRef = doc(db, `artifacts/${appId}/users/${userId}/userProfiles`, "myProfile");
                await setDoc(profileRef, userProfile);
                console.log("Profile Page: Profile changes saved to Firestore successfully!");
                goBackToDashboard(); // Redirect after successful save
            } catch (error) {
                console.error("Profile Page: Error saving profile to Firestore:", error);
            }
        }

        /**
         * Function to navigate back to the dashboard.
         * No longer passes data via URL as it's now stored in Firestore.
         */
        function goBackToDashboard() {
            console.log("Profile Page: Navigating back to dashboard.");
            window.location.href = `./dashboardTeachers.html`; // No URL parameters needed
        }

        /**
         * Previews the selected image from the file input.
         * @param {Event} event The change event from the file input.
         */
        function previewImage(event) {
            const profilePicture = document.getElementById('profile-picture');
            const file = event.target.files[0];

            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    profilePicture.src = e.target.result;
                    userProfile.profileImage = e.target.result; // Update profile data immediately
                    console.log("Profile Page: Image preview updated. New image data length:", e.target.result.length);
                };
                reader.readAsDataURL(file);
            }
        }

        // Initialize Firebase and load profile data when the page loads
        window.onload = async function() {
            // Global variables provided by the Canvas environment
            appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase config is missing or empty.");
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Profile Page: Signed in with custom token.");
                } else {
                    await signInAnonymously(auth);
                    console.log("Profile Page: Signed in anonymously.");
                }
                userId = auth.currentUser?.uid || crypto.randomUUID();
                console.log("Profile Page: User ID:", userId);

                // Try to load existing profile from Firestore
                const profileRef = doc(db, `artifacts/${appId}/users/${userId}/userProfiles`, "myProfile");
                const profileSnap = await getDoc(profileRef);

                if (profileSnap.exists()) {
                    userProfile = profileSnap.data();
                    console.log("Profile Page: Loaded profile from Firestore:", userProfile);
                } else {
                    console.log("Profile Page: No existing profile found in Firestore. Using default.");
                }
                loadProfileData();

            } catch (error) {
                console.error("Profile Page: Firebase initialization or data loading error:", error);
            }
        };
    </script>
</body>
</html>
